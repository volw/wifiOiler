<!DOCTYPE html><html lang="de">
<head>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Konfiguration</title>

	<link rel="stylesheet" href="wifiOiler.css">
	<script>
		var configVal = "";
		var line = 0;
		var theUrl="/config";
		var oldval=[];
		
		const $ = function(id){return document.getElementById(id);}
		function msgBase(msg,tpl,func){$("id_msgbox").innerHTML = msg;$("id_msgbox").appendChild($(tpl).content.cloneNode(true));$("id_msgbox").style.display = "block";$("mb_btnYes").onclick = function(){$('id_msgbox').style.display='none';if (typeof(func)=='function') func();}}
		function meldung(msg, func){msgBase(msg,"onebtn",func);}
		function frage(msg, func){msgBase(msg,"twobtn",func);$("mb_btnNo").onclick = function(){$('id_msgbox').style.display="none";}}

		function onBodyLoad(){getConfig();$("sim").addEventListener("input", calc);}
		function calc() {
       var meter = $("sim").value;
       var kmh = (meter * 3.6);
			 $("kmh").innerText = " = " + kmh.toFixed(1) + " km/h";
    }
		
    function setValues(){
			JSON.parse( configVal, function(key,value) {
				var o=$(key);
        if(o!=null) {
          if (key=="bac" && value != "") value=window.atob(value);
					o.value=value;
          oldval[key]=value;
					o.onblur = function() {check(key)}
					if (o.type!="select-one") o.onclick=function(){this.select()}}})}

		function putConfig(){
			var parms="";
			JSON.parse(configVal,
        function( key, value ) {
          var o=$(key);
          if (o != null && o.value != value) {
            if (parms.length > 4) parms += "&";
            if (key=="bac") {
              parms+="bac=";
              if (o.value != "") parms += window.btoa(o.value);
            } else if (o.value != ""||key=="gts"){	// gts darf leer sein
              parms += key+"="+ o.value;
            }
          }
        });
			xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function(){if(this.readyState==4&&this.status==200) meldung("Konfiguration wurde gesichert!",(function (){window.location.href = "/";}));};
			//if (parms.length>3){
				xmlHttp.open("GET", theUrl+"?"+parms, true);xmlHttp.send(null);
			//}else alert(unescape("Keine Werte ge%E4ndert%21"));
}
		function getConfig(){
			xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function(){
				if (xmlHttp.readyState == 4){
					configVal = xmlHttp.responseText;setValues();calc();
					$("wait").hidden=true;$("form").hidden=false;}};
			xmlHttp.open("GET", theUrl, true);
			xmlHttp.send(null);}
		function resUse(){$("use").value=0;check("use");}
		function check(id){var o=$(id);if (o!=null)
		  if (o.value != oldval[id]) o.setAttribute('class', 'changed');
			else o.setAttribute('class', '');}
		</script>
	</head>
<body onload="onBodyLoad();">
<div id=wait hidden=true><b align=center>Formular wird geladen...</b></div>
<div id=form class="config">
<b>Ge&auml;nderte Werte werden rot hinterlegt...</b><br>
<label for="wts">Wartezeit Simulation</label><input type="number" id="wts" name="wts"/>
<label for="nmm">Normal Mode Meter </label><input type="number" id="nmm" name="nmm"/>
<label for="rmm">Rain Mode Meter</label><input type="number" id="rmm" name="rmm"/>
<label for="omm">Offroad Mode Meter </label><input type="number" id="omm" name="omm"/>
<label for="sim">Meter/s bei Simulation </label>
<span><input type="number" id="sim" name="sim"/><label id="kmh"></label></span>
<label for="pac">Anzahl Pumpaktionen pro &Ouml;lvorgang</label><input type="number" id="pac" name="pac"/>
<label for="glf">GPS Low-Filter (cm)</label><input type="number" id="glf" name="glf"/>
<label for="otk">&Ouml;ltank Kapazit&auml;t</label><input type="number" id="otk" name="otk"/>
<label for="use">...davon verbraucht</label><span><input type="number" id="use" name="use"/>
<input type="button" value="reset" style="width:60px;" onclick="resUse();"/></span>
<label for="ffn">Name neuer Firmware Datei</label><input type="text" id="ffn" name="ffn"/>
<label for="fpw">Sek. zw. GPS Trackpoints <br>(0 = no tracks)</label><input type="number" id="fpw" name="fpw"/>
<label for="apn">eigener Host/Access Point Name</label><input type="text" id="apn" name="apn"/>
<label for="app">Access Point Passwort</label><input type="text" id="app" name="app"/>
<label for="uhn">Upload Host Name</label><input type="text" id="uhn" name="uhn"/>
<label for="uhp">Upload Host Port</label><input type="number" id="uhp" name="uhp"/>
<label for="url">Upload Host URL</label><input type="text" id="url" name="url"/>
<label for="bac">User:Password for basic authentication at oilerbase<br>
(empty for no basic auth.)</label><input type="text" id="bac" name="bac"/>
<label for="lgf">Logging to file?</label>
<select name="lgf" id="lgf" ><option value=1>Ja</option><option value=0>Nein</option></select>
<label for="lgs">Logging to Serial?</label>
<select name="lgs" id="lgs" ><option value=1>Ja</option><option value=0>Nein</option></select>
<label for="gdl">GPS Logging to File?</label>
<select name="gdl" id="gdl" ><option value=1>Ja</option><option value=0>Nein</option></select>
<label for="wso">WiFi automatisch starten?</label>
<select name="wso" id="wso" ><option value=1>Ja</option><option value=0>Nein</option></select>
<label for="gts">GPS track file: Zusatz vor Dateiname (max. 10 Zeichen)<br>
Ohne Zusatz werden die Namen wie folgt gebildet: YYMMDD-HHMM.dat
(upload all track files before changing it)</label><input type="text" id="gts" name="gts" maxlength="10"/>
<input type="button" value="Speichern" class="myButton" onclick="putConfig()"/>
<input type="button" value="Abbruch"   class="myButton" onclick="history.back()"/>
<div id="id_msgbox" display="none" align="center"></div>
<template id="onebtn"><br><br><button id="mb_btnYes">OK</button></template>
<template id="twobtn"><br><br><button id="mb_btnYes">Ja</button><button id="mb_btnNo">Nein</button></template>
</div></body></html>