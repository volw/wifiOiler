<!DOCTYPE html>
<html lang="de">
<head><title>Update</title>
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="wifiOiler.css">
<style>
	.wrapper {margin-left:auto;margin-right:auto;
    display: block; position: relative; width: 150px; height: 150px;}
</style>
<script src="/animation.js"></script>
<script>
var animation = new Animation();
function init(){animation.init(ge("wrapper"));animation.run();doUpdate();}
function ge(s){return document.getElementById(s)}
function doUpdate(){
	xmlHttp = new XMLHttpRequest();
  xmlHttp.timeout = 10000;
	xmlHttp.onreadystatechange = function(){
	  if (xmlHttp.readyState == 4) {  // 4 = done
      if (xmlHttp.status == 500){
        ge("status").innerHTML = xmlHttp.responseText;
        updateEnd();
      }
      else requestAnimationFrame(()=>checkResult());
	}};
	xmlHttp.open("GET", "/update?update", true);
	xmlHttp.send(null);
}
function updateEnd(){animation.stop();ge("button").hidden=false;}
function checkResult(){
	xmlHttp = new XMLHttpRequest();
	//xmlHttp.timeout = 30000;
	xmlHttp.ontimeout = function(){
		ge("status").innerHTML = "<b>FEHLER: &Ouml;ler konnte nicht erreicht werden.<br>WiFi anschalten oder neu booten</b>"
		  + "<br>Update sollte erneut durchgef&uuml;hrt werden<br>(neue Versionsnummer erkennbar?)";
    updateEnd();		
	}
	xmlHttp.onreadystatechange = function(){
	  if (xmlHttp.readyState == 4) {  // 4 = done
	    if(xmlHttp.status == 200) {
        var result = xmlHttp.responseText;
        if (result == "NOUPDATE"){
          ge("status").innerHTML = "Kein Update aktiv!";
          updateEnd();
        } else if (result.startsWith("UPDATEOK:")) {
          ge("status").innerHTML = result.substr("UPDATEOK:".length) + "<br>Update abgeschlossen!<br>";
          updateEnd();
        } else if (result.startsWith("REBOOT:")){
          ge("status").innerHTML = result.substr("REBOOT:".length) + "<br>Datei(en) hochgeladen<br>Die neue Firmware wird jetzt eingespielt.<br>Danach wird der &Ouml;ler automatisch neu gestartet...<br>";
          updateEnd();
        } else if (result.startsWith("UPDERROR:")){
          ge("status").innerHTML = result.substr("UPDERROR:".length) + "<br>Update leider fehlgeschlagen<br>Update Dateien wurden gel√∂scht.<br>";
          updateEnd();
        } else {
          ge("status").innerHTML = "Update aktiv - uploading files:<br>" + result;
          //requestAnimationFrame(() => checkResult());
          window.setTimeout(checkResult, 1500);
	} } } };
	//xmlHttp.open("GET", "http://wifioiler.fritz.box/update?result", true);
	xmlHttp.open("GET", "/update?result", true);
	xmlHttp.send(null);
}
document.addEventListener("DOMContentLoaded", init);
</script>
</head>
<body>
	<center>
		<h2>wifiOiler Update<br>Bitte warten...<br></h2>
		<div id="wrapper" class="wrapper">
		</div>
		<b><div id="status" name="status"></div></b>
    <div id="button" name="button" hidden>
      <a href=/><button type="button" class="myButton">Zur&uuml;ck</button></a>
    </div>
	</center>
</body>
</html>
